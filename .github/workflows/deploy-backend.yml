name: Deploy Backend to Azure App Service (SPN)

on:
  push:
    branches: [ "develop" ] # 或者你的主部署分支，如 "main"
    paths:
      - 'backend/**'        # 仅当 backend 文件夹下的文件发生变化时触发
      - '.github/workflows/deploy-backend.yml' # 当此工作流文件本身发生变化时也触发 (可选)
  workflow_dispatch:        # 允许手动触发

env:
  AZURE_BACKEND_WEBAPP_NAME: 'wedev'       # 你的 Azure App Service (后端) 名称
  AZURE_BACKEND_PACKAGE_PATH: './backend' # 指向你的后端代码文件夹
  NODE_VERSION_BACKEND: '20.x'            # 后端 Node.js 版本

permissions:
  contents: read # 'build_backend' job 需要读取代码

jobs:
  build_backend:
    name: Build Backend Artifact
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js for Backend ${{ env.NODE_VERSION_BACKEND }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION_BACKEND }}
        cache: 'npm'
        cache-dependency-path: '${{ env.AZURE_BACKEND_PACKAGE_PATH }}/package-lock.json'

    - name: Install backend dependencies, build, and test
      working-directory: ${{ env.AZURE_BACKEND_PACKAGE_PATH }}
      run: |
        npm install
        npm run build --if-present # 如果你有构建脚本
        npm run test --if-present  # 如果你有测试脚本

    - name: Upload backend artifact for deployment job
      uses: actions/upload-artifact@v4
      with:
        name: node-app-backend # 构建产物的名称 (后端)
        path: ${{ env.AZURE_BACKEND_PACKAGE_PATH }} # 上传 backend 文件夹的内容

  deploy_backend:
    name: Deploy Backend to Azure App Service
    permissions:
      contents: none # Deploy job 不需要直接读取代码内容，它使用 artifact
    runs-on: ubuntu-latest
    needs: build_backend # 依赖 build_backend 作业完成
    environment:
      name: 'Development_Backend' # 后端部署环境的名称
      url: ${{ steps.deploy-to-backend-webapp.outputs.webapp-url }} # 部署后的 URL

    steps:
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: node-app-backend # 与 build_backend job 中上传的产物名称一致

    - name: Login to Azure using Service Principal
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }} # **使用你存储 SPN JSON 的机密**

    - name: 'Deploy to Azure WebApp (Backend)'
      id: deploy-to-backend-webapp # 给步骤一个 id 以便引用其输出
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_BACKEND_WEBAPP_NAME }}
        package: . # 部署当前工作目录的内容 (即下载的后端构建产物)

    - name: Logout from Azure (Backend)
      run: |
        az logout
        az account clear
      if: always()